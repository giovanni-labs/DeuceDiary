# Deuce Diary — iOS REST API Contract
*Generated by Qwen3-14B Claude Distill, Feb 20 2026*

# API Contract

## Overview

### Base URL
`https://api.deuceapp.com`

### Authentication
JWT Bearer Token in `Authorization` header.

### Rate Limits
- **Unauthenticated:** 100 requests per hour
- **Authenticated:** 500 requests per hour
- **Group-specific:** 100 requests per hour per group

---

## Websocket

### `ws://api.deuceapp.com`

**Auth:** Required (JWT in query parameter)

**iOS Note:** Use `URLSessionWebSocketTask` with token in query. Reconnect on close with backoff.

```swift
// Swift example
var reconnectAttempts = 0
let maxReconnectAttempts = 5
let reconnectDelay: TimeInterval = 3.0

func connectWebSocket() {
    let url = URL(string: "wss://api.deuceapp.com?token=\(token)")!
    do {
        let task = try session.webSocket(url: url)
        task.delegate = self
        // ... handle messages
    } catch {
        if reconnectAttempts < maxReconnectAttempts {
            DispatchQueue.timer(withInterval: reconnectDelay, repeats: true) { timer in
                connectWebSocket()
                timer.invalidate()
            }
        }
    }
}

extension YourClass: URLSessionWebSocketDelegate {
    func urlSession(_ session: URLSession, webSocketTask: URLSessionWebSocketTask, didCloseWith closeError: Error?) {
        // Handle reconnect logic
    }
}
```

---

## GET /

**Auth:** Not required

**Response 200:**

```json
{
  "docs": "https://docs.deuceapp.com",
  "api_version": "v1",
  "status": "production",
  "features": {
    "streak_notifications": true,
    "websocket": true,
    "invite_expiration": "7_days"
  }
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 503 | Service unavailable |

---

## GROUPS

### GET /api/groups

**Auth:** Required

**Request:**

```json
{
  "page": 1,
  "limit": 10,
  "filter": "all|active|created",
  "sort": "recent|alphabetical"
}
```

**Response 200:**

```json
{
  "groups": [
    {
      "id": "group_123",
      "name": "Mountain Climbers",
      "description": "Weekend climbing adventures",
      "created_by": "user_456",
      "current_streak": 7,
      "longest_streak": 15,
      "last_streak_date": "2024-02-15",
      "member_count": 8,
      "my_role": "member",
      "is_joined": true,
      "cover_url": "https://cdn.deuceapp.com/groups/mountain-cover.jpg",
      "banner_url": "https://cdn.deuceapp.com/groups/mountain-banner.jpg"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 24
  }
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 400 | Invalid filter or sort parameter |
| 401 | Authentication failed |
| 500 | Internal server error |

**iOS Note:** Cache this response for 5 minutes using `NSCache` or `UserDefaults`.

### POST /api/groups

**Auth:** Required

**Request:**

```json
{
  "name": "New Group",
  "description": "This is a new group for deuces",
  "cover_image_url": "https://example.com/image.jpg",
  "banner_image_url": "https://example.com/banner.jpg",
  "is_private": false,
  "invite_link": "https://deuceapp.com/invite/abc123"
}
```

**Response 201:**

```json
{
  "group": {
    "id": "group_789",
    "name": "New Group",
    "description": "This is a new group for deuces",
    "created_by": "user_456",
    "current_streak": 0,
    "longest_streak": 0,
    "last_streak_date": null,
    "member_count": 1,
    "my_role": "creator",
    "is_joined": true,
    "cover_url": "https://cdn.deuceapp.com/groups/default-cover.jpg",
    "banner_url": "https://cdn.deuceapp.com/groups/default-banner.jpg"
  },
  "redirect_url": "/groups/group_789"
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 400 | Group name too short or invalid characters |
| 409 | Group name already exists |
| 422 | Validation error (missing required fields) |
| 500 | Internal server error |

### GET /api/groups/:groupId

**Auth:** Required

**Response 200:**

```json
{
  "group": {
    "id": "group_123",
    "name": "Mountain Climbers",
    "description": "Weekend climbing adventures",
    "created_by": "user_456",
    "current_streak": 7,
    "longest_streak": 15,
    "last_streak_date": "2024-02-15",
    "member_count": 8,
    "is_joined": true,
    "my_role": "member",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-02-15T10:30:00Z",
    "cover_url": "https://cdn.deuceapp.com/groups/mountain-cover.jpg",
    "banner_url": "httpssystem"
  },
  "members": [
    {
      "id": "user_456",
      "username": "john_doe",
      "first_name": "John",
      "last_name": "Doe",
      "profile_url": "https://cdn.deuceapp.com/users/john_doe.jpg",
      "role": "admin",
      "is_me": false
    },
    {
      "id": "user_789",
      "username": "jane_smith",
      "first_name": "Jane",
      "last_name": "Smith",
      "profile_url": "https://cdn.deuceapp.com/users/jane_smith.jpg",
      "role": "member",
      "is_me": true
    }
  ],
  "statistics": {
    "total_deuces": 42,
    "active_members": 8,
    "pending_invites": 2,
    "streak_active": true
  }
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 401 | Authentication failed |
| 403 | Forbidden (not a member) |
| 404 | Group not found |
| 500 | Internal server error |

### PATCH /api/groups/:groupId

**Auth:** Required

**Request:**

```json
{
  "name": "Updated Group Name",
  "description": "This group has been updated",
  "cover_image_url": "https://example.com/new-cover.jpg",
  "banner_image_url": "https://example.com/new-banner.jpg",
  "is_private": true,
  "invite_link": "https://deuceapp.com/invite/new-abc123"
}
```

**Response 200:**

```json
{
  "group": {
    "id": "group_123",
    "name": "Updated Group Name",
    "description": "This group has been updated",
    "created_by": "user_456",
    "current_streak": 7,
    "longest_streak": 15,
    "last_streak_date": "2024-02-15",
    "member_count": 8,
    "is_joined": true,
    "my_role": "member",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-02-15T11:00:00Z",
    "cover_url": "https://cdn.deuceapp.com/groups/new-cover.jpg",
    "banner_url": "https://cdn.deuceapp.com/groups/new-banner.jpg"
  }
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 400 | Group name too short or invalid characters |
| 401 | Authentication failed |
| 403 | Forbidden (not admin) |
| 409 | Group name already exists |
| 422 | Validation error |
| 500 | Internal server error |

### DELETE /api/groups/:groupId

**Auth:** Required

**Response 204:**

```json
{}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 401 | Authentication failed |
| 403 | Forbidden (not creator) |
| 404 | Group not found |
| 500 | Internal server error |

---

## GROUP MEMBERS

### GET /api/groups/:groupId/members

**Auth:** Required

**Response 200:**

```json
{
  "members": [
    {
      "id": "user_456",
      "username": "john_doe",
      "first_name": "John",
      "last_name": "Doe",
      "profile_url": "https://cdn.deuceapp.com/users/john_doe.jpg",
      "role": "admin",
      "is_me": false,
      "is_active": true,
      "joined_at": "2024-01-10T00:00:00Z"
    },
    {
      "id": "user_789",
      "username": "jane_smith",
      "first_name": "Jane",
      "last_name": "Smith",
      "profile_url": "https://cdn.deuceapp.com/users/jane_smith.jpg",
      "role": "member",
      "is_me": true,
      "is_active": true,
      "joined_at": "2024-01-15T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 8
  }
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 401 | Authentication failed |
| 403 | Forbidden (not admin) |
| 404 | Group not found |
| 500 | Internal server error |

### POST /api/groups/:groupId/members

**Auth:** Required

**Request:**

```json
{
  "user_ids": ["user_789", "user_101"],
  "roles": ["member", "member"]
}
```

**Response 201:**

```json
{
  "added_members": [
    {
      "id": "user_789",
      "username": "jane_smith",
      "first_name": "Jane",
      "last_name": "Smith",
      "profile_url": "https://cdn.deuceapp.com/users/jane_smith.jpg",
      "role": "member",
      "is_me": true
    }
  ],
  "existing_members": [
    {
      "id": "user_101",
      "username": "existing_user",
      "first_name": "Existing",
      "last_name": "User",
      "profile_url": "https://cdn.deuceapp.com/users/existing_user.jpg",
      "role": "member",
      "is_me": false
    }
  ]
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 400 | Invalid roles specified |
| 401 | Authentication failed |
| 403 | Forbidden (not admin) |
| 404 | Group or users not found |
| 500 | Internal server error |

### PATCH /api/groups/:groupId/members/:memberId

**Auth:** Required

**Request:**

```json
{
  "role": "admin"
}
```

**Response 200:**

```json
{
  "member": {
    "id": "user_789",
    "username": "jane_smith",
    "first_name": "Jane",
    "last_name": "Smith",
    "profile_url": "https://cdn.deuceapp.com/users/jane_smith.jpg",
    "role": "admin",
    "is_me": true,
    "is_active": true,
    "joined_at": "2024-01-15T00:00:00Z"
  }
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 401 | Authentication failed |
| 403 | Forbidden (not admin) |
| 404 | Group or member not found |
| 500 | Internal server error |

### DELETE /api/groups/:groupId/members/:memberId

**Auth:** Required

**Response 204:**

```json
{}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 401 | Authentication failed |
| 403 | Forbidden (not admin or trying to remove self) |
| 404 | Group or member not found |
| 500 | Internal server error |

---

## GROUP INVITES

### POST /api/groups/:groupId/invite

**Auth:** Required

**Request:**

```json
{
  "user_ids": ["user_101", "user_102"],
  "message": "Join our climbing group for the weekend trip!"
}
```

**Response 201:**

```json
{
  "invites": [
    {
      "id": "invite_abc123",
      "group_id": "group_123",
      "from_user_id": "user_456",
      "to_user_id": "user_101",
      "message": "Join our climbing group for the weekend trip!",
      "status": "pending",
      "created_at": "2024-02-15T10:00:00Z",
      "expires_at": "2024-02-22T10:00:00Z",
      "accepted_at": null,
      "rejected_at": null
    }
  ]
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 400 | No users specified or message too long |
| 401 | Authentication failed |
| 403 | Forbidden (not admin) |
| 404 | Group not found |
| 422 | Validation error |
| 500 | Internal server error |

### GET /api/groups/:groupId/invites

**Auth:** Required

**Response 200:**

```json
{
  "invites": [
    {
      "id": "invite_abc123",
      "group_id": "group_123",
      "from_user_id": "user_456",
      "to_user_id": "user_101",
      "message": "Join our climbing group for the weekend trip!",
      "status": "pending",
      "created_at": "2024-02-15T10:00:00Z",
      "expires_at": "2024-02-22T10:00:00Z",
      "accepted_at": null,
      "rejected_at": null
    },
    {
      "id": "invite_def456",
      "group_id": "group_123",
      "from_user_id": "user_789",
      "to_user_id": "user_456",
      "message": "You're invited to our new project!",
      "status": "accepted",
      "created_at": "2024-02-14T14:30:00Z",
      "expires_at": "2024-02-21T14:30:00Z",
      "accepted_at": "2024-02-15T09:15:00Z",
      "rejected_at": null
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 2
  }
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 401 | Authentication failed |
| 403 | Forbidden (not member) |
| 404 | Group not found |
| 500 | Internal server error |

### GET /api/users/invites

**Auth:** Required

**Response 200:**

```json
{
  "invites": [
    {
      "id": "invite_abc123",
      "group_id": "group_123",
      "group_name": "Climbing Group",
      "from_user_id": "user_456",
      "from_user_username": "john_doe",
      "to_user_id": "user_101",
      "message": "Join our climbing group for the weekend trip!",
      "status": "pending",
      "created_at": "2024-02-15T10:00:00Z",
      "expires_at": "2024-02-22T10:00:00Z",
      "accepted_at": null,
      "rejected_at": null
    }
  ]
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 401 | Authentication failed |
| 500 | Internal server error |

### PATCH /api/groups/:groupId/invites/:inviteId

**Auth:** Required

**Request:**

```json
{
  "status": "accepted"
}
```

**Response 200:**

```json
{
  "invite": {
    "id": "invite_abc123",
    "group_id": "group_123",
    "from_user_id": "user_456",
    "to_user_id": "user_101",
    "message": "Join our climbing group for the weekend trip!",
    "status": "accepted",
    "created_at": "2024-02-15T10:00:00Z",
    "expires_at": "2024-02-22T10system
    "accepted_at": "2024-02-15T10:30:00Z",
    "rejected_at": null
  }
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 401 | Authentication failed |
| 403 | Forbidden (not invitee) |
| 404 | Invite not found |
| 422 | Invalid status |
| 500 | Internal server error |

### POST /api/join/:inviteId

**Auth:** Required

**Purpose:** Accept an invite link and join the associated group. The `inviteId` is a UUID from the invite link.

**Request:**

No body required. The `inviteId` path parameter identifies the invite.

**Response 200:**

```json
{
  "group": {
    "id": "group_123",
    "name": "Mountain Climbers"
  },
  "message": "Successfully joined group"
}
```

**Errors:**

| Status | Reason |
|--------|--------|
| 400 | Invalid or expired invite |
| 401 | Authentication failed |
| 409 | Already a member of this group |
| 500 | Internal server error |

**iOS Note:** Handle universal/deep links (`deucediary://join/<inviteId>`) by extracting the `inviteId` and calling `POST /api/join/:inviteId` directly.

---

## DEUCES

### CREATE DEUCE

I'll focus on the core functionality of creating a deuce, which represents a climbing partnership or team. This requires careful validation and relationship management between users.

**Request Requirements:**
- Two distinct users
- Clear role designation (leader/second/support)
- Valid route information
- Proper access control

```python
{
  "leader_id": "user_456",
  "second_id": "user_789",
  "route": {
    "name": "Test Route",
    "grade": "5.10a",
    "location": "Local Gym"
  },
  "date": "2024-02-16",
  "notes": "Worked the route cleanly. Good beta shared."
}
```

### RESPONSE

```python
{
  "deuce": {
    "id": "deuce_xyz789",
    "leader_id": "user_456",
    "second_id": "user_789",
    "route": {
      "name": "Test Route",
      "grade": "5.10a",
      "location": "Local Gym"
    },
    "date": "2024-02-16",
    "notes": "Worked the route cleanly. Good beta shared.",
    "created_at": "2024-02-15T11:00:00Z",
    "updated_at": "2024-02-15T11:00:00Z",
    "status": "active"
  }
}
```

### LIST DEUCES

I need to retrieve deuces based on user's role and relationships. This involves filtering deuces where the user is either leader, second, or part of the route's associated group.

```python
{
  "deuces": [
    {
      "id": "deuce_xyz789",
      "leader_id": "user_456",
      "second_id": "user_789",
      "route": {
        "name": "Test Route",
        "grade": "5.10a",
        "location": "Local Gym"
      },
      "date": "2024-02-16",
      "notes": "Worked the route cleanly. Good beta shared.",
      "created_at": "2024-02-15T11:00:00Z",
      "updated_at": "2024-02-15T11:00:00Z",
      "status": "active"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 1
  }
}
```

### RETRIEVE SPECIFIC DEUCE

When accessing a deuce, I need to verify the user's permission level. The user must be either the leader, second, or have administrative rights to view detailed information.

```python
{
  "deuce": {
    "id": "deuce_xyz78system
    "leader_id": "user_456",
    "second_id": "user_789",
    "route": {
      "name": "Test Route",
      "grade": "5.10a",
      "location": "Local Gym"
    },
    "date": "2024-02-16",
    "notes": "Worked the route cleanly. Good beta shared.",
    "created_at": "2024-02-15T11:00:00Z",
    "updated_at": "2024-02-15T11:00:00Z",
    "status": "active"
  }
}
```

### UPDATE DEUCE

Modifications to a deuce require careful validation. Only the leader or administrator can make changes, ensuring route details remain accurate and consistent.

```python
{
  "deuce": {
    "id": "deuce_xyz789",
    "leader_id": "user_456",
    "second_id": "user_789",
    "route": {
      "name": "Test Route",
      "grade": "5.10a",
      "location": "Local Gym"
    },
    "date": "2024-02-16",
    "notes": "Updated notes: Added new beta sequences.",
    "created_at": "2024-02-15T11:00:00Z",
    "updated_at": "2024-02-15T11:30:00Z",
    "status": "active"
  }
}
```

### DELETE DEUCE

Removing a deuce is irreversible. Only the leader or administrator can delete, preventing accidental loss of climbing data.

```python
{
  "message": "Deuce deleted successfully."
}
```

### ADDITIONAL CONSIDERATIONS

I need to handle complex relationship scenarios:
1. User permissions across different roles
2. Route validation against existing routes
3. Date format standardization
4. Notes character limits
5. Status transition rules (active → completed → cancelled)
6. Duplicate deuce prevention
7. Transactional integrity for partner assignments
8. Cache invalidation for real-time updates
9. Audit logging for changes
10. Pagination optimization for large datasets
</think>

 # Deuce API Documentation

## Create a Deuce

### Request

```python
{
  "leader_id": "user_456",
  "second_id": "user_789",
  "route": {
    "name": "Test Route",
    "grade": "5.10a",
    "location": "Local Gym"
  },
  "date": "2024-02-16",
  "notes": "Worked the route cleanly. Good beta shared."
}
```

### Response

```python
{
  "deuce": {
    "id": "deuce_xyz789",
    "leader_id": "user_456",
    "second_id": "user_789",
    "route": {
      "name": "Test Route",
      "grade": "5.10a",
      "location": "Local Gym"
    },
    "date": "2024-02-16",
    "notes": "Worked the route cleanly. Good beta shared.",
    "created_at": "2024-02-15T11:00:00Z",
    "updated_at": "2024-02-15T11:00:00Z",
    "status": "active"
  }
}
```

## List Deuces

### Request

```python
GET /deuces
```

### Response

```python
{
  "deuces": [
    {
      "id": "deuce_xyz789",
      "leader_id": "user_456",
      "second_id": "user_789",
      "route": {
        "name": "Test Route",
        "grade": "5.10a",
        "location": "Local Gym"
      },
      "date": "2024-02-16",
      "notes": "Worked the route cleanly. Good beta shared.",
      "created_at": "2024-02-15T11:00:00Z",
      "updated_at": "2024-02-15T11:00:00Z",
      "status": "active"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 1
  }
}
```

## Retrieve a Specific Deuce

### Request

```python
GET /deuces/deuce_xyz789
```

### Response

```python
{
  "deuce": {
    "id": "deuce_xyz789",
    "leader_id": "user_456",
    "second_id": "user_789",
    "route": {
      "name": "Test Route",
      "grade": "5.10a",
      "location": "Local Gym"
    },
    "date": "2024-02-16",
    "notes": "Worked the route cleanly. Good beta shared.",
    "created_at": "2024-02-15T11:00:00Z",
    "updated_at": "2024-02-15T11:00:00Z",
    "status": "active"
  }
}
```

## Update a Deuce

### Request

```python
PATCH /deuces/deuce_xyz789
{
  "notes": "Updated notes: Added new beta sequences."
}
```

### Response

```python
{
  "deuce": {
    "id": "deuce_xyz789",
    "leader_id": "user_456",
    "second_id": "user_789",
    "route": {
      "name": "Test Route",
      "grade": "5.10a",
      "location": "Local Gym"
    },
    "date": "2024-02-16",
    "notes": "Updated notes: Added new beta sequences.",
    "created_at": "2024-02-15T11:00:00Z",
    "updated_at": "2024-02-15T11:30:00Z",
    "status": "active"
  }
}
```

## Delete a Deuce

### Request

```python
DELETE /deuces/deuce_xyz789
```

### Response

```python
{
  "message": "Deuce deleted successfully."
}
```

